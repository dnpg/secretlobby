# ==============================================================================
# SecretLobby.io - Nginx Configuration
# Handles subdomain routing and custom domains for multi-tenant platform
# ==============================================================================

# Map to extract subdomain from host
# Example: myband.secretlobby.io -> subdomain = myband
map $host $subdomain {
    default "";
    ~^(?<sub>[^.]+)\.secretlobby\.io$ $sub;
    ~^(?<sub>[^.]+)\.secretlobby\.local$ $sub;  # For local development
}

# Map to check if this is a known system subdomain
map $subdomain $is_system_subdomain {
    default 0;
    "www"    1;
    "api"    1;
    "admin"  1;
    "app"    1;
    "static" 1;
}

# ==============================================================================
# Main Server - Subdomains (*.secretlobby.io)
# ==============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name *.secretlobby.io *.secretlobby.local secretlobby.io secretlobby.local;

    # Redirect HTTP to HTTPS in production (uncomment when SSL is configured)
    # return 301 https://$host$request_uri;

    # For development without SSL:
    include /etc/nginx/conf.d/locations.inc;
}

# HTTPS server (uncomment when SSL certificates are available)
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name *.secretlobby.io secretlobby.io;
#
#     ssl_certificate /etc/nginx/ssl/secretlobby.io/fullchain.pem;
#     ssl_certificate_key /etc/nginx/ssl/secretlobby.io/privkey.pem;
#     ssl_session_timeout 1d;
#     ssl_session_cache shared:SSL:50m;
#     ssl_session_tickets off;
#
#     # Modern SSL configuration
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#
#     # HSTS
#     add_header Strict-Transport-Security "max-age=63072000" always;
#
#     include /etc/nginx/conf.d/locations.inc;
# }

# ==============================================================================
# Custom Domains Server
# Catches all other domains and routes them to the app
# The app will look up the domain in the database
# ==============================================================================
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    # For custom domains without SSL
    include /etc/nginx/conf.d/locations.inc;
}

# HTTPS for custom domains (requires dynamic SSL or wildcard cert handling)
# server {
#     listen 443 ssl http2 default_server;
#     listen [::]:443 ssl http2 default_server;
#     server_name _;
#
#     # Default/fallback SSL certificate
#     ssl_certificate /etc/nginx/ssl/default/fullchain.pem;
#     ssl_certificate_key /etc/nginx/ssl/default/privkey.pem;
#
#     include /etc/nginx/conf.d/locations.inc;
# }
