// Multi-tenant schema for secretlobby.io
// Band/Artist lobby landing pages platform

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/client"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  OWNER // Full access, can delete account
  ADMIN // Full access except account deletion
  EDITOR // Can edit lobbies and content
  VIEWER // Read-only access
}

enum DomainStatus {
  PENDING // DNS not yet verified
  VERIFIED // DNS verified and active
  FAILED // DNS verification failed
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  PAUSED
  TRIALING
}

enum PaymentStatus {
  SUCCEEDED
  PENDING
  FAILED
  REFUNDED
}

enum MediaType {
  IMAGE
  AUDIO
  VIDEO
  EMBED
}

enum EmbedProvider {
  YOUTUBE
  VIMEO
}

enum ViolationStatus {
  ACTIVE   // Currently tracking violations
  RESOLVED // User succeeded after violations
  BLOCKED  // IP is blocked
  EXPIRED  // Violations aged out
}

enum InvitationStatus {
  PENDING   // Not yet used
  USED      // Account created
  EXPIRED   // Time expired
  REVOKED   // Admin revoked
}

// ============================================================================
// ACCOUNT (Tenant)
// ============================================================================

model Account {
  id   String @id @default(cuid())
  name String // Organization/Band name
  slug String @unique // Subdomain: {slug}.secretlobby.io

  // Subscription & Billing
  subscriptionTier SubscriptionTier @default(FREE)
  stripeCustomerId String?          @unique

  // Global account settings (JSON)
  settings Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          AccountUser[]
  lobbies        Lobby[]
  domains        Domain[]
  media          Media[]
  subscriptions  Subscription[]
  paymentMethods PaymentMethod[]
  paymentHistory PaymentHistory[]
  defaultLobbyId String? // Reference to the default lobby

  @@index([slug])
}

// ============================================================================
// USER
// ============================================================================

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String
  name         String?
  avatarUrl    String?

  // Email verification
  emailVerified    Boolean @default(false)
  emailVerifyToken String?

  // Password reset
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Login lockout
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  accounts AccountUser[]
  sessions Session[]

  @@index([email])
}

// ============================================================================
// ACCOUNT USER (Junction table with role)
// ============================================================================

model AccountUser {
  id        String   @id @default(cuid())
  accountId String
  userId    String
  role      UserRole @default(VIEWER)

  // Invitation tracking
  invitedAt  DateTime  @default(now())
  acceptedAt DateTime?
  invitedBy  String? // User ID who sent the invite

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
  @@index([accountId])
  @@index([userId])
}

// ============================================================================
// SESSION
// ============================================================================

model Session {
  id     String @id @default(cuid())
  userId String
  token  String @unique

  // Session context
  accountId String? // Currently active account
  userAgent String?
  ipAddress String?

  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ============================================================================
// LOBBY (Landing Page)
// ============================================================================

model Lobby {
  id        String @id @default(cuid())
  accountId String

  // Basic info
  name        String // Internal name
  slug        String // URL path: {account-slug}.secretlobby.io/{lobby-slug}
  title       String? // Public title
  description String? // Public description

  // Status
  isPublished Boolean @default(false)
  isDefault   Boolean @default(false) // Is this the account's default lobby?

  // Access control
  password     String? // Optional password protection
  requiresAuth Boolean @default(false)

  // Content & Settings (JSON)
  // Includes: theme, background, banner, playlist, band info, etc.
  settings Json @default("{}")

  // Media references (FK to Media table)
  backgroundMediaId     String?
  backgroundMediaDarkId String?
  bannerMediaId         String?
  bannerMediaDarkId     String?
  profileMediaId        String?
  profileMediaDarkId    String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  account             Account              @relation(fields: [accountId], references: [id], onDelete: Cascade)
  tracks              Track[]
  rateLimitViolations RateLimitViolation[] @relation("LobbyViolations")
  backgroundMedia     Media?               @relation("LobbyBackground", fields: [backgroundMediaId], references: [id], onDelete: SetNull)
  backgroundMediaDark Media?               @relation("LobbyBackgroundDark", fields: [backgroundMediaDarkId], references: [id], onDelete: SetNull)
  bannerMedia         Media?               @relation("LobbyBanner", fields: [bannerMediaId], references: [id], onDelete: SetNull)
  bannerMediaDark     Media?               @relation("LobbyBannerDark", fields: [bannerMediaDarkId], references: [id], onDelete: SetNull)
  profileMedia        Media?               @relation("LobbyProfile", fields: [profileMediaId], references: [id], onDelete: SetNull)
  profileMediaDark    Media?               @relation("LobbyProfileDark", fields: [profileMediaDarkId], references: [id], onDelete: SetNull)

  @@unique([accountId, slug])
  @@index([accountId])
  @@index([slug])
}

// ============================================================================
// TRACK (Audio tracks for a lobby)
// ============================================================================

model Track {
  id      String @id @default(cuid())
  lobbyId String

  // Track info
  title    String
  artist   String?
  filename String // Storage reference (legacy — prefer media relation)
  duration Int? // Duration in seconds (legacy — prefer media.duration)

  // HLS streaming (legacy — prefer media.hlsReady / media.waveformPeaks)
  hlsReady      Boolean @default(false)
  waveformPeaks Json? // number[] — pre-computed waveform peak amplitudes

  // Media reference (new)
  mediaId String?

  // Ordering
  position Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lobby Lobby @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  media Media? @relation(fields: [mediaId], references: [id], onDelete: SetNull)

  @@index([lobbyId])
  @@index([lobbyId, position])
  @@index([mediaId])
}

// ============================================================================
// DOMAIN (Custom domains)
// ============================================================================

model Domain {
  id        String @id @default(cuid())
  accountId String

  // Domain info
  domain String @unique // e.g., "music.mybandname.com"

  // Verification
  status            DomainStatus @default(PENDING)
  verificationToken String       @unique @default(cuid())
  verifiedAt        DateTime?
  lastCheckedAt     DateTime?

  // SSL
  sslEnabled   Boolean   @default(false)
  sslExpiresAt DateTime?

  // Target lobby (optional - defaults to account's default lobby)
  lobbyId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@index([accountId])
}

// ============================================================================
// MEDIA (Centralized media library)
// ============================================================================

model Media {
  id        String @id @default(cuid())
  accountId String

  filename  String       // Original filename
  key       String       // R2 object key (empty for embeds)
  mimeType  String       // e.g. "image/jpeg"
  size      Int          // File size in bytes
  type      MediaType

  width     Int?         // Image-only
  height    Int?         // Image-only
  duration  Int?         // Audio/Video duration in seconds
  alt       String?      // User-editable alt text (also used for search)

  // Audio processing
  hlsReady      Boolean @default(false)
  waveformPeaks Json?   // number[] — pre-computed waveform peak amplitudes
  metadata      Json?   // Additional metadata (e.g. audio codec info)

  provider  EmbedProvider?  // YouTube or Vimeo
  embedUrl  String?         // Full embed URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Inverse relations (Lobby media slots)
  lobbyBackgrounds     Lobby[] @relation("LobbyBackground")
  lobbyBackgroundDarks Lobby[] @relation("LobbyBackgroundDark")
  lobbyBanners         Lobby[] @relation("LobbyBanner")
  lobbyBannerDarks     Lobby[] @relation("LobbyBannerDark")
  lobbyProfiles        Lobby[] @relation("LobbyProfile")
  lobbyProfileDarks    Lobby[] @relation("LobbyProfileDark")

  // Inverse relation (Tracks using this media)
  tracks    Track[]

  @@index([accountId, type])
  @@index([accountId, createdAt])
}

// ============================================================================
// AUDIT LOG (Optional - for tracking changes)
// ============================================================================

model AuditLog {
  id        String  @id @default(cuid())
  accountId String?
  userId    String?

  // Action details
  action     String // e.g., "lobby.created", "domain.verified"
  entityType String? // e.g., "Lobby", "Domain"
  entityId   String?

  // Change data
  oldData Json?
  newData Json?

  // Context
  ipAddress String?
  userAgent String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================================================
// SUBSCRIPTION (Payment subscriptions)
// ============================================================================

model Subscription {
  id        String @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Gateway info
  gatewayId             String // 'stripe', 'paypal', etc.
  gatewaySubscriptionId String // External subscription ID
  gatewayCustomerId     String // External customer ID

  // Subscription details
  tier                SubscriptionTier
  status              SubscriptionStatus @default(ACTIVE)
  billingPeriod       String?            // 'monthly' or 'yearly'

  // Billing cycle
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  cancelAtPeriodEnd   Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gatewayId, gatewaySubscriptionId])
  @@index([accountId])
  @@index([status])
}

// ============================================================================
// PAYMENT METHOD
// ============================================================================

model PaymentMethod {
  id        String @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Gateway info
  gatewayId               String
  gatewayPaymentMethodId  String

  // Card details (for display only - no sensitive data)
  type        String    // 'card', 'paypal', 'bank_account'
  last4       String?
  brand       String?   // 'visa', 'mastercard', etc.
  expiryMonth Int?
  expiryYear  Int?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([accountId])
}

// ============================================================================
// PAYMENT HISTORY
// ============================================================================

model PaymentHistory {
  id             String  @id @default(cuid())
  accountId      String
  account        Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  subscriptionId String?

  // Gateway info
  gatewayId        String
  gatewayPaymentId String

  // Payment details
  amount      Int           // In cents
  currency    String        @default("usd")
  status      PaymentStatus
  description String?

  // URLs for receipts/invoices
  invoiceUrl  String?
  receiptUrl  String?

  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([createdAt])
}

// ============================================================================
// SYSTEM SETTINGS (Platform-wide configuration)
// ============================================================================

model SystemSettings {
  id    String @id @default("default") // Singleton - always "default"

  // Payment Gateway Configuration
  enabledGateways  String[] @default(["stripe"]) // ['stripe', 'paypal']
  defaultGateway   String   @default("stripe")

  // Platform Settings
  platformName     String   @default("SecretLobby")
  supportEmail     String   @default("support@secretlobby.io")

  // Feature Flags
  allowSignups     Boolean  @default(true)
  maintenanceMode  Boolean  @default(false)
  prelaunchMode    Boolean  @default(false)

  // Favicon & Web Manifest Configuration (JSON)
  // Contains: sourceKey, generatedAt, manifestName, manifestShortName, themeColor, bgColor, display
  faviconConfig    Json     @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// SUBSCRIPTION PLAN (Configurable subscription plans)
// ============================================================================

model SubscriptionPlan {
  id          String  @id @default(cuid())

  // Plan Identity
  name        String           // Display name (e.g., "Starter")
  slug        String  @unique  // Internal identifier (e.g., "STARTER")
  description String?          // Short description

  // Pricing (in cents)
  priceMonthly Int    @default(0)
  priceYearly  Int    @default(0)
  currency     String @default("usd")

  // External Gateway Price IDs
  stripePriceMonthly String?  // Stripe price ID for monthly
  stripePriceYearly  String?  // Stripe price ID for yearly
  paypalPlanMonthly  String?  // PayPal plan ID for monthly
  paypalPlanYearly   String?  // PayPal plan ID for yearly

  // Features (JSON array of feature strings)
  features Json @default("[]")

  // Limits
  maxSongs     Int     @default(5)     // Max songs allowed
  maxLobbies   Int     @default(1)     // Max lobbies allowed
  maxStorage   Int     @default(100)   // Max storage in MB
  customDomain Boolean @default(false) // Allow custom domains
  apiAccess    Boolean @default(false) // Allow API access

  // Display
  highlighted Boolean @default(false)  // Show as "Most Popular"
  position    Int     @default(0)      // Sort order
  isActive    Boolean @default(true)   // Show in pricing page

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive, position])
}

// ============================================================================
// RATE LIMIT VIOLATION (Security & Brute Force Protection)
// ============================================================================

model RateLimitViolation {
  id             String          @id @default(cuid())

  // Identification
  ipAddress      String
  endpoint       String          // "login", "lobby-password", "signup", etc.
  resourceId     String?         // Lobby ID, account ID, etc.

  // Tracking
  violationCount Int             @default(1)
  firstViolation DateTime        @default(now())
  lastViolation  DateTime        @updatedAt
  lockoutUntil   DateTime?
  status         ViolationStatus @default(ACTIVE)

  // Additional Context
  userAgent      String?
  metadata       Json?           // Any additional context (geo, fingerprint, etc.)

  // Timestamps
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  lobby          Lobby?          @relation("LobbyViolations", fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([ipAddress, endpoint, resourceId])
  @@index([status, lockoutUntil])
  @@index([lastViolation])
  @@index([createdAt])
}

// ============================================================================
// INTERESTED PERSON (Marketing email collection)
// ============================================================================

model InterestedPerson {
  id           String      @id @default(cuid())
  email        String      @unique
  name         String?
  source       String?     // e.g., "marketing-hero", "marketing-cta"
  ipAddress    String?
  userAgent    String?
  inviteSentAt DateTime?   // When invite was sent
  convertedAt  DateTime?   // When they signed up
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  invitation   Invitation?

  @@index([email])
  @@index([createdAt])
}

// ============================================================================
// INVITATION (Invite links for prelaunch)
// ============================================================================

model Invitation {
  id                 String           @id @default(cuid())
  email              String           @unique
  code               String           @unique  // 64-char secure token
  status             InvitationStatus @default(PENDING)
  sentAt             DateTime?
  usedAt             DateTime?
  expiresAt          DateTime         // Default 7 days from creation
  sentBy             String?          // Admin user ID
  note               String?
  interestedPersonId String?          @unique
  interestedPerson   InterestedPerson? @relation(fields: [interestedPersonId], references: [id], onDelete: SetNull)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([email])
  @@index([code])
  @@index([status])
  @@index([expiresAt])
}
